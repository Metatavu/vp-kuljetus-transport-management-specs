openapi: 3.0.3
info:
  version: 1.0.0
  title: VP-Kuljetus User Management Services

security:
  - BearerAuth: [driver, manager]
  - ApiKeyAuth: []

x-tyk-api-gateway:
  info:
    id: user-management-services
    orgId: vp
    name: User Management Services
    state:
      active: true
  upstream:
    url: http://user-management
  server:
    listenPath:
      value: /user-management/
      strip: true

paths:
  /v1/system/ping:
    get:
      operationId: ping
      summary: Replies with pong
      description: Replies ping with pong
      security: []
      tags:
        - System
      responses:
        "200":
          description: Pong
          content:
            text/plain:
              schema:
                type: string

  /v1/drivers:
    get:
      operationId: listDrivers
      summary: List Drivers.
      description: Lists Drivers.
      security:
        - BearerAuth: [manager]
        - ApiKeyAuth: []
      tags:
        - Drivers
        - SpecManagementUI
      parameters:
        - name: driverCardId
          in: query
          description: Filter drivers by driver card ID. Will return 0 to 1 drivers.
          schema:
            type: string
        - name: archived
          in: query
          description: Filter drivers by archived status
          schema:
            type: boolean
        - name: first
          in: query
          description: First result.
          schema:
            type: integer
        - name: max
          in: query
          description: Max results.
          schema:
            type: integer
      responses:
        "200":
          description: List of routes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Driver"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  "/v1/drivers/{driverId}":
    get:
      operationId: findDriver
      summary: Find a driver.
      description: Finds a driver by id.
      security:
        - BearerAuth: [driver, manager]
      tags:
        - Drivers
        - SpecApp
        - SpecManagementUI
      parameters:
        - name: driverId
          required: true
          in: path
          description: driver's id
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Found driver
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Driver"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /v1/employees:
    get:
      operationId: listEmployees
      summary: List Employees.
      description: Lists Employees. A user is considered an employee if they're given the employee realm role.
      security:
        - BearerAuth: [manager]
      tags:
        - Employees
        - SpecManagementUI
      parameters:
        - name: search
          in: query
          description: Search string. Should search from first and last names.
          schema:
            type: string
        - name: salaryGroup
          in: query
          description: Filter employees by salary group
          schema:
            $ref: "#/components/schemas/SalaryGroup"
        - name: type
          in: query
          description: Filter employees by type
          schema:
            $ref: "#/components/schemas/EmployeeType"
        - name: office
          in: query
          description: Filter employees by office
          schema:
            $ref: "#/components/schemas/Office"
        - name: archived
          in: query
          description: Filter employees by archived status
          schema:
            type: boolean
        - name: first
          in: query
          description: First result.
          schema:
            type: integer
            default: 0
        - name: max
          in: query
          description: Max results.
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: List of employees
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Employee"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      operationId: createEmployee
      summary: Create Employee.
      description: Creates Employee. All new users created via this endpoint should be given the employee realm role.
      security:
        - BearerAuth: [manager]
      tags:
        - Employees
        - SpecManagementUI
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Employee"
      responses:
        "201":
          description: Created employee
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Employee"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  "/v1/employees/{employeeId}":
    get:
      operationId: findEmployee
      summary: Find an employee.
      description: Finds an employee by id.
      security:
        - BearerAuth: [manager]
      tags:
        - Employees
        - SpecManagementUI
      parameters:
        - name: employeeId
          required: true
          in: path
          description: employee's id
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Found employee
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Employee"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      operationId: updateEmployee
      summary: Update Employee.
      description: Updates Employee.
      security:
        - BearerAuth: [manager]
      tags:
        - Employees
        - SpecManagementUI
      parameters:
        - name: employeeId
          required: true
          in: path
          description: employee's id
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Employee"
      responses:
        "200":
          description: Updated employee
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Employee"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      operationId: deleteEmployee
      summary: Delete Employee.
      description: |
        Deletes Employee.
        This should only be allowed to be used in tests. In production usage the employee should be archived instead.
      security:
        - BearerAuth: [manager]
      tags:
        - Employees
        - SpecManagementUI
      parameters:
        - name: employeeId
          required: true
          in: path
          description: employee's id
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Empty response indicating successful removal
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  "/v1/employees/{employeeId}/timeEntries":
    get:
      operationId: listEmployeeTimeEntries
      summary: List Employees Time Entries.
      description: Lists Employees Time Entries. Sort by start time, latest first.
      security:
        - BearerAuth: [manager, driver, employee]
      tags:
        - TimeEntries
        - SpecApp
        - SpecManagementUI
      parameters:
        - name: employeeId
          required: true
          in: path
          description: employee's id
          schema:
            type: string
            format: uuid
        - name: start
          in: query
          description: Start time for time entries.
          schema:
            type: string
            format: date-time
        - name: end
          in: query
          description: End time for time entries.
          schema:
            type: string
            format: date-time
        - name: first
          in: query
          description: First result.
          schema:
            type: integer
            default: 0
        - name: max
          in: query
          description: Max results.
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: List of time entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TimeEntry"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      operationId: createEmployeeTimeEntry
      summary: Create Employees Time Entry.
      description: |
        Creates Employees Time Entry.

        Attempt to create new time entry should fail if:
          1) New time entry does not have endTime but there is already one time entry without endTime for the same employee. This is because time entries without endTime are considered to be running timers and only one is allowed at a time.
          2) If time new entry intersects with an existing time entry.
      security:
        - BearerAuth: [manager, driver, employee]
      tags:
        - TimeEntries
        - SpecApp
        - SpecManagementUI
      parameters:
        - name: employeeId
          required: true
          in: path
          description: employee's id
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TimeEntry"
      responses:
        "201":
          description: Created time entry
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TimeEntry"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  "/v1/employees/{employeeId}/timeEntries/{timeEntryId}":
    get:
      operationId: findEmployeeTimeEntry
      summary: Find an employee's time entry.
      description: Finds an employee's time entry by id.
      security:
        - BearerAuth: [manager, driver, employee]
      tags:
        - TimeEntries
        - SpecApp
        - SpecManagementUI
      parameters:
        - name: employeeId
          required: true
          in: path
          description: employee's id
          schema:
            type: string
            format: uuid
        - name: timeEntryId
          required: true
          in: path
          description: time entry's id
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Found time entry
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TimeEntry"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      operationId: updateEmployeeTimeEntry
      summary: Update Employee's Time Entry.
      description: |
        Updates Employee's Time Entry.
      
        Update should fail, when:
        1) Modified entry does not have endTime but there is already another entry without endTime present in the system for same employee.  This is because time entries without endTime are considered to be running timers and only one is allowed at a time.
        2) If modifying the entry would lead it to intersect with another time entry.
      security:
        - BearerAuth: [manager, employee]
      tags:
        - TimeEntries
        - SpecApp
        - SpecManagementUI
      parameters:
        - name: employeeId
          required: true
          in: path
          description: employee's id
          schema:
            type: string
            format: uuid
        - name: timeEntryId
          required: true
          in: path
          description: time entry's id
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TimeEntry"
      responses:
        "200":
          description: Updated time entry
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TimeEntry"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      operationId: deleteEmployeeTimeEntry
      summary: Delete Employee's Time Entry.
      description: Deletes Employee's Time Entry. Only accessible by managers.
      security:
        - BearerAuth: [manager]
      tags:
        - TimeEntries
        - SpecManagementUI
      parameters:
        - name: employeeId
          required: true
          in: path
          description: employee's id
          schema:
            type: string
            format: uuid
        - name: timeEntryId
          required: true
          in: path
          description: time entry's id
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Deleted time entry
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  "/v1/workTypes":
    get:
      operationId: listWorkTypes
      summary: List Work Types.
      description: Lists Work Types.
      security:
        - BearerAuth: [manager, driver, employee]
      tags:
        - WorkTypes
        - SpecApp
        - SpecManagementUI
      parameters:
        - name: category
          in: query
          description: Filter work types by category
          schema:
            $ref: "#/components/schemas/WorkTypeCategory"
      responses:
        "200":
          description: List of work types
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/WorkType"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      operationId: createWorkType
      summary: Create Work Type.
      description: Creates Work Type.
      security:
        - BearerAuth: [manager]
      tags:
        - WorkTypes
        - SpecManagementUI
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkType"
      responses:
        "201":
          description: Created work type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkType"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  "/v1/workTypes/{workTypeId}":
    get:
      operationId: findWorkType
      summary: Find a work type.
      description: Finds a work type by id.
      security:
        - BearerAuth: [manager]
      tags:
        - WorkTypes
        - SpecManagementUI
      parameters:
        - name: workTypeId
          required: true
          in: path
          description: work type's id
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Found work type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkType"
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      operationId: deleteWorkType
      summary: Delete Work Type.
      description: Deletes Work Type.
      security:
        - BearerAuth: [manager]
      tags:
        - WorkTypes
        - SpecManagementUI
      parameters:
        - name: workTypeId
          required: true
          in: path
          description: work type's id
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Deleted work type
        "default":
          description: Invalid request was sent to the server
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  schemas:
    Error:
      type: object
      description: Error object
      required:
        - status
        - message
      properties:
        status:
          type: integer
          format: int32
        message:
          type: string

    Driver:
      type: object
      description: Represents single truck driver
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        displayName:
          type: string
          description: Driver display name
        archivedAt:
          type: string
          format: date-time
          description: >
            Setting the archivedAt time marks the driver as archived.
            Drivers marked as archived will not appear in list requests unless archived filter is set to true.
            Archived driver cannot be updated, unless archivedAt is first set to null.

    Employee:
      type: object
      description: Represents single employee
      required:
        - firstName
        - lastName
        - type
        - salaryGroup
        - office
        - employeeNumber
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        firstName:
          type: string
          description: Employee's first name
        lastName:
          type: string
          description: Employee's last name
        driverCardId:
          type: string
          description: Employee's driver card ID.
        type:
          $ref: "#/components/schemas/EmployeeType"
        salaryGroup:
          $ref: "#/components/schemas/SalaryGroup"
        office:
          $ref: "#/components/schemas/Office"
        regularWorkingHours:
          type: number
          format: float
          description: |
            Employee's regular working hours per two weeks. Used for employee's whose salary group is either Driver or VPLogistics.
        driverCardLastReadOut:
          type: string
          format: date-time
          description: |
            Last time the driver card was read out. In the beginning this should be set manually but later probably automated.
        employeeNumber:
          type: string
          description: Employee's number. Should be unique.
        email:
          type: string
          description: Employee's email address
        phoneNumber:
          type: string
          description: Employee's phone number
        archivedAt:
          type: string
          format: date-time
          description: >
            Setting the archivedAt time marks the employee as archived.
            Employees marked as archived will not appear in list requests unless archived filter is set to true.
            Archived employee cannot be updated, unless archivedAt is first set to null.

    EmployeeType:
      type: string
      description: |
        Employee's type described as finnish abbreviation. UI implementations should translate these to more human readable form.
        Pakettiautonkuljettaja (PA)
        Kuorma-auton kuljettaja (KA)
        Alihankkija (AH)
        Vuokratyöntekijä (VK)
        Työharjoittelija (TH)
        Tilapäistyöntekijä (TP)
        Ajojärjestelijä (AJ)
        Esimies (JH)
        Aikatuntipalkka (AP)
        Kuukausipalkka (KK)
        Ei-aktiivinen (POIS)
        Täysperäkuljettaja (TPK)
      enum: [PA, KA, AH, VK, TH, TP, AJ, JH, AP, KK, POIS, TPK]

    SalaryGroup:
      type: string
      description: |
        Employee's salary group
        Kuljettaja (Driver) - Should be default IF the employees office is not KOTKA
        VP-Logistics (VPlogistics)
        Office
        Terminal
      enum: [DRIVER, VPLOGISTICS, OFFICE, TERMINAL]

    Office:
      type: string
      description: Employee's office. Salary group should be set to VPLogistics if the office is KOTKA
      enum: [KOTKA, KOUVOLA, RAUHA]

    TimeEntry:
      type: object
      description: Represents single time entry
      required:
        - employeeId
        - startTime
        - workTypeId
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        employeeId:
          type: string
          format: uuid
          description: Employee's id
        startTime:
          type: string
          format: date-time
          description: Time entry start time
        endTime:
          type: string
          format: date-time
          description: |
            Time entry end time. End time is not required for time entries that are still running.
            If an employee has an existing time entry without an end time and the new entry is missing end time,
            the new time entry should not be created and instead a bad request is to be returned.
            When a new entry is created with both start and end times, the existing entry is ignored.
        workTypeId:
          type: string
          format: uuid
          description: Work type id

    WorkType:
      type: object
      description: Describes different work types that employees can have
      required:
        - name
        - category
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        name:
          type: string
          description: Work type name
        category:
           $ref: "#/components/schemas/WorkTypeCategory"

    WorkTypeCategory:
      type: string
      description: Describes work type's category
      enum: [DRIVER, TERMINAL, OFFICE]